import{$ as e,u as t,r as a,j as r,_ as s,M as l,c as i,a0 as n,T as d,g as c,v as m,H as o,s as x,I as h,a1 as p}from"./index-bGB9rp9t.js";import{S as u}from"./SubscriptionQRCode-DiDsB8Sr.js";import{m as y}from"./motion-DaFSZY4b.js";const b=()=>{const[b]=e(),g=t(),N=b.get("plan"),j=b.get("billing")||"monthly",f=b.get("gymName"),[v,k]=a.useState(null),[S,w]=a.useState(null),[_,C]=a.useState(!0),[D,M]=a.useState(!1),[I,P]=a.useState(null),[$,q]=a.useState(!1),[A,Y]=a.useState(null),[E,O]=a.useState({cardNumber:"",expiryDate:"",cvv:"",cardholderName:"",billingAddress:"",city:"",zipCode:"",country:"US"});a.useEffect(()=>{(async()=>{C(!0),P(null);try{const{user:e,error:t}=await m.getUser();if(t||!e)return void g("/login");w(e);const{data:a}=await o.getById(e.id);if(a&&O(t=>({...t,cardholderName:`${a.first_name||""} ${a.last_name||""}`.trim()||e.email})),!N)throw new Error("No plan selected");{const{data:e,error:t}=await x.getAll();if(t)throw new Error(t.message);const a=e.find(e=>e.id===N);if(!a)throw new Error("Plan not found");k(a)}}catch(e){P(e.message||"Failed to initialize payment")}finally{C(!1)}})()},[N,g]);const U=e=>{const{name:t,value:a}=e.target;let r=a;"cardNumber"===t&&(r=a.replace(/\s/g,"").replace(/(.{4})/g,"$1 ").trim(),r.length>19&&(r=r.slice(0,19))),"expiryDate"===t&&(r=a.replace(/\D/g,"").replace(/(\d{2})(\d)/,"$1/$2"),r.length>5&&(r=r.slice(0,5))),"cvv"===t&&(r=a.replace(/\D/g,"").slice(0,4)),O(e=>({...e,[t]:r}))};return _?r.jsx("div",{className:"min-h-screen py-16 flex items-center justify-center",children:r.jsxs("div",{className:"animate-pulse flex flex-col items-center",children:[r.jsx("div",{className:"w-16 h-16 bg-light-border dark:bg-dark-border rounded-full mb-4"}),r.jsx("div",{className:"h-4 bg-light-border dark:bg-dark-border rounded w-32"})]})}):I&&!v?r.jsx("div",{className:"min-h-screen py-16 flex items-center justify-center",children:r.jsxs("div",{className:"card p-8 max-w-md mx-auto text-center",children:[r.jsx("div",{className:"text-error-600 dark:text-error-400 text-5xl mb-4",children:"âš ï¸"}),r.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Payment Error"}),r.jsx("p",{className:"text-light-textSecondary dark:text-dark-textSecondary mb-6",children:I}),r.jsx("button",{onClick:()=>g("/plans"),className:"btn btn-primary",children:"Back to Plans"})]})}):r.jsxs("div",{className:"min-h-screen py-16 bg-gray-50 dark:bg-dark-background",children:[r.jsxs("div",{className:"container-custom max-w-6xl",children:[r.jsxs(y.div,{className:"flex items-center mb-8",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.3},children:[r.jsxs("button",{onClick:()=>g(-1),className:"flex items-center text-primary-600 dark:text-primary-500 mr-4",children:[r.jsx(s,{className:"mr-2"}),"Back"]}),r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold",children:"Complete Your Subscription"}),r.jsx("p",{className:"text-light-textSecondary dark:text-dark-textSecondary",children:"Secure payment powered by industry-leading encryption"})]})]}),r.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[r.jsx("div",{className:"lg:col-span-2",children:r.jsx(y.div,{className:"card",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:r.jsxs("form",{onSubmit:async e=>{e.preventDefault();const t=(()=>{const e=[];return(!E.cardNumber||E.cardNumber.replace(/\s/g,"").length<16)&&e.push("Valid card number is required"),E.expiryDate&&/^\d{2}\/\d{2}$/.test(E.expiryDate)||e.push("Valid expiry date is required (MM/YY)"),(!E.cvv||E.cvv.length<3)&&e.push("Valid CVV is required"),E.cardholderName.trim()||e.push("Cardholder name is required"),e})();if(t.length>0)P(t.join(", "));else{M(!0),P(null);try{const e="FM"+Date.now().toString().slice(-8)+Math.random().toString(36).substr(2,4).toUpperCase(),t=Math.random().toString(36).substr(2,8).toUpperCase(),a=new Date,r=new Date;"monthly"===j?r.setMonth(r.getMonth()+1):r.setFullYear(r.getFullYear()+1);const s={user_id:S.id,plan_id:v.id,membership_id:e,status:"active",billing_type:j,start_date:a.toISOString(),end_date:r.toISOString(),verification_code:t,qr_code_data:JSON.stringify({membershipId:e,planName:v.name,memberName:E.cardholderName,validUntil:r.toISOString(),planType:j,gymAccess:v.gym_access_description,verificationCode:t,issueDate:a.toISOString(),gymName:f||null,price:"monthly"===j?v.price_monthly:v.price_yearly})},{data:l,error:i}=await h.create(s);if(i)throw new Error(i.message);const n=l?.[0]?.id||l?.id,d="monthly"===j?v.price_monthly:v.price_yearly,{error:c}=await p.from("payments_log").insert([{user_id:S.id,subscription_id:n,plan:v.name,amount:d,status:"completed",payment_method:"Credit Card",transaction_reference:`TXN-${Date.now()}-${Math.random().toString(36).substr(2,9).toUpperCase()}`}]);await o.update(S.id,{subscription_level:v.name});const m={membershipId:e,planName:v.name,memberName:E.cardholderName,validUntil:r.toISOString(),planType:j,gymAccess:v.gym_access_description,price:"monthly"===j?v.price_monthly:v.price_yearly,gymName:f||null,verificationCode:t};Y(m),q(!0)}catch(a){P(a.message||"Payment failed. Please try again.")}finally{M(!1)}}},children:[r.jsxs("div",{className:"mb-8",children:[r.jsxs("h2",{className:"text-2xl font-bold mb-6 flex items-center",children:[r.jsx(l,{className:"mr-3 text-primary-600 dark:text-primary-500"}),"Payment Information"]}),I&&r.jsx("div",{className:"bg-error-50 dark:bg-error-900/20 border border-error-200 dark:border-error-800 text-error-700 dark:text-error-400 p-4 rounded-lg mb-6",children:I}),r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-2",children:"Card Number *"}),r.jsxs("div",{className:"relative",children:[r.jsx("input",{type:"text",name:"cardNumber",value:E.cardNumber,onChange:U,className:"input pl-12 w-full",placeholder:"1234 5678 9012 3456",required:!0}),r.jsx(l,{className:"absolute left-4 top-1/2 -translate-y-1/2 text-light-textSecondary dark:text-dark-textSecondary"})]})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-2",children:"Expiry Date *"}),r.jsx("input",{type:"text",name:"expiryDate",value:E.expiryDate,onChange:U,className:"input w-full",placeholder:"MM/YY",required:!0})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-2",children:"CVV *"}),r.jsx("input",{type:"text",name:"cvv",value:E.cvv,onChange:U,className:"input w-full",placeholder:"123",required:!0})]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-2",children:"Cardholder Name *"}),r.jsxs("div",{className:"relative",children:[r.jsx("input",{type:"text",name:"cardholderName",value:E.cardholderName,onChange:U,className:"input pl-12 w-full",placeholder:"John Doe",required:!0}),r.jsx(i,{className:"absolute left-4 top-1/2 -translate-y-1/2 text-light-textSecondary dark:text-dark-textSecondary"})]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-2",children:"Billing Address"}),r.jsx("input",{type:"text",name:"billingAddress",value:E.billingAddress,onChange:U,className:"input w-full mb-4",placeholder:"123 Main Street"}),r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsx("input",{type:"text",name:"city",value:E.city,onChange:U,className:"input w-full",placeholder:"City"}),r.jsx("input",{type:"text",name:"zipCode",value:E.zipCode,onChange:U,className:"input w-full",placeholder:"ZIP Code"})]})]})]})]}),r.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 p-4 rounded-lg mb-6",children:r.jsxs("div",{className:"flex items-start",children:[r.jsx(n,{className:"text-blue-600 dark:text-blue-400 mr-3 mt-0.5"}),r.jsxs("div",{children:[r.jsx("h4",{className:"font-semibold text-blue-900 dark:text-blue-300 mb-1",children:"Secure Payment"}),r.jsx("p",{className:"text-sm text-blue-700 dark:text-blue-400",children:"Your payment information is encrypted and secure. We never store your card details."})]})]})}),r.jsx("button",{type:"submit",className:"w-full btn btn-primary btn-lg flex items-center justify-center",disabled:D,children:D?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full mr-3"}),"Processing Payment..."]}):r.jsxs(r.Fragment,{children:[r.jsx(d,{className:"mr-3"}),"Complete Payment - $","monthly"===j?v?.price_monthly:v?.price_yearly]})})]})})}),r.jsx("div",{className:"lg:col-span-1",children:r.jsxs(y.div,{className:"card sticky top-24",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.2},children:[r.jsx("h3",{className:"text-xl font-bold mb-6",children:"Order Summary"}),r.jsxs("div",{className:"space-y-4 mb-6",children:[r.jsxs("div",{className:"flex justify-between items-start",children:[r.jsxs("div",{children:[r.jsxs("h4",{className:"font-semibold",children:[v?.name," Plan"]}),r.jsxs("p",{className:"text-sm text-light-textSecondary dark:text-dark-textSecondary",children:["monthly"===j?"Monthly":"Annual"," ","subscription"]})]}),r.jsxs("div",{className:"text-right",children:[r.jsxs("span",{className:"text-xl font-bold",children:["$","monthly"===j?v?.price_monthly:v?.price_yearly]}),r.jsxs("p",{className:"text-sm text-light-textSecondary dark:text-dark-textSecondary",children:["/","monthly"===j?"month":"year"]})]})]}),f&&r.jsxs("div",{className:"bg-light-background dark:bg-dark-background p-3 rounded-lg",children:[r.jsx("p",{className:"text-sm font-medium",children:"Gym Access:"}),r.jsx("p",{className:"text-sm text-light-textSecondary dark:text-dark-textSecondary",children:f})]})]}),r.jsxs("div",{className:"border-t border-light-border dark:border-dark-border pt-6 mb-6",children:[r.jsx("h4",{className:"font-semibold mb-3",children:"What's Included:"}),r.jsx("ul",{className:"space-y-2",children:v&&(v.features||[]).slice(0,5).map((e,t)=>r.jsxs("li",{className:"flex items-start text-sm",children:[r.jsx(c,{className:"text-success-500 mr-2 mt-0.5 flex-shrink-0",size:14}),r.jsx("span",{children:e})]},t))})]}),r.jsxs("div",{className:"border-t border-light-border dark:border-dark-border pt-6",children:[r.jsxs("div",{className:"flex justify-between items-center mb-2",children:[r.jsx("span",{className:"font-semibold",children:"Total:"}),r.jsxs("span",{className:"text-2xl font-bold text-primary-600 dark:text-primary-500",children:["$","monthly"===j?v?.price_monthly:v?.price_yearly]})]}),r.jsxs("p",{className:"text-xs text-light-textSecondary dark:text-dark-textSecondary",children:["yearly"===j&&"Billed annually â€¢ ","Cancel anytime"]})]}),r.jsxs("div",{className:"mt-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg",children:[r.jsx("h4",{className:"font-semibold text-green-900 dark:text-green-300 mb-2",children:"ðŸ“± Digital Membership Included"}),r.jsx("p",{className:"text-sm text-green-700 dark:text-green-400",children:"Get instant access with your QR code membership card after payment."})]})]})})]})]}),$&&A&&r.jsx(u,{subscriptionData:A,onClose:()=>{q(!1),g("/profile?tab=subscription&success=true")}})]})};export{b as default};
